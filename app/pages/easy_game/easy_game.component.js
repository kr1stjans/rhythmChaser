"use strict";
var core_1 = require("@angular/core");
var page_1 = require("ui/page");
var nativescript_accelerometer_1 = require("nativescript-accelerometer");
var nativescript_audio_1 = require("nativescript-audio");
var zscore_1 = require("../../shared/detection_algorithms/zscore");
var kalmanjs_1 = require("../../shared/detection_algorithms/kalmanjs");
var label_1 = require("ui/label");
var absolute_layout_1 = require("ui/layouts/absolute-layout");
var file_system_1 = require("file-system");
var platform_1 = require("platform");
var text_view_1 = require("ui/text-view");
var EasyGameComponent = (function () {
    function EasyGameComponent(zone, page) {
        this.zone = zone;
        this.page = page;
        this.lastValue = 0;
        this.buffer = [];
        this.zscore = new zscore_1.zScore(5, 3.5, 0.1);
        this.kalman = new kalmanjs_1.KalmanFilter({ R: 5, Q: 0.01 });
        // animation variables
        this.animationPositions = [20, 60, 100, 140, 180, 220];
        this.animationDirection = AnimationDirection.INCREASING;
        this.animationPosition = this.animationPositions.length / 2;
        // score variables
        this.score = 0;
        this.scoreMultiplier = 1;
        this.gestureMade = false;
    }
    EasyGameComponent.prototype.ngOnDestroy = function () {
        this.player.pause();
        nativescript_accelerometer_1.stopAccelerometerUpdates();
    };
    EasyGameComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.scoresLayout = this.page.getViewById("scoresLayout");
        this.player = new nativescript_audio_1.TNSPlayer();
        // create tempo
        var tempoContainer = new absolute_layout_1.AbsoluteLayout();
        tempoContainer.cssClass = "tempo-container";
        absolute_layout_1.AbsoluteLayout.setLeft(tempoContainer, 0);
        absolute_layout_1.AbsoluteLayout.setTop(tempoContainer, 300);
        this.scoresLayout.addChild(tempoContainer);
        var textView = new text_view_1.TextView();
        textView.cssClass = "tempo";
        absolute_layout_1.AbsoluteLayout.setLeft(textView, (platform_1.screen.mainScreen.widthDIPs / 2) - 5);
        absolute_layout_1.AbsoluteLayout.setTop(textView, -200);
        tempoContainer.addChild(textView);
        var right = tempoContainer.createAnimation({ target: tempoContainer, rotate: 30, duration: 350 });
        var left = tempoContainer.createAnimation({ target: tempoContainer, rotate: -30, duration: 700 });
        var center = tempoContainer.createAnimation({ target: tempoContainer, rotate: 0, duration: 350 });
        function play() {
            right.play().then(function () {
                left.play().then(function () {
                    center.play().then(function () {
                        play();
                    });
                });
            });
        }
        play();
        // read beats file
        file_system_1.knownFolders.currentApp().getFile("/audio/faded.csv").readText().then(function (text) {
            _this.beatArray = text.split(",").map(function (value) {
                return +value;
            });
        }).then(function () {
            // start playing song
            _this.playAudio("~/audio/faded.mp3", "localFile");
            _this.startTime = new Date().getTime();
            // start accelerometer updates
            nativescript_accelerometer_1.startAccelerometerUpdates(function (data) {
                _this.zone.run(function () {
                    var result = _this.naiveFilter(data.x + data.y + data.z);
                    var signalHigh = _this.detectSignalHigh(result);
                    if (signalHigh) {
                        _this.gestureMade = true;
                    }
                    //console.log(data.x + data.y + data.z);
                });
            });
        });
        // view must be manually updated every 100ms or it overuses the cpu and no update is processed
        setInterval(function () {
            // if gesture was made check if actual beat exists
            if (_this.gestureMade) {
                var actualBeatExists = false;
                var timeSinceStartInSeconds = (new Date().getTime() - _this.startTime) / 1000;
                for (var _i = 0, _a = _this.beatArray; _i < _a.length; _i++) {
                    var beat = _a[_i];
                    // beat at current time detected
                    var diff = Math.abs(beat - timeSinceStartInSeconds);
                    if (diff < 0.125) {
                        actualBeatExists = true;
                        break;
                    }
                }
                var label = new label_1.Label();
                label.cssClass = "big-text score-label";
                label.text = "+" + (actualBeatExists ? _this.scoreMultiplier : 0);
                absolute_layout_1.AbsoluteLayout.setLeft(label, _this.animationPositions[_this.animationPosition]);
                absolute_layout_1.AbsoluteLayout.setTop(label, 425);
                _this.scoresLayout.addChild(label);
                var animation = label.createAnimation({
                    translate: { x: 0, y: -425 },
                    opacity: 0.5,
                    duration: 2000,
                    scale: { x: 0.5, y: 0.5 },
                });
                animation.play().then(function () {
                    _this.scoresLayout.removeChild(label);
                });
                if (actualBeatExists) {
                    _this.score += _this.scoreMultiplier;
                    _this.scoreMultiplier++;
                }
                else {
                    _this.scoreMultiplier = 1;
                }
                // adjust position
                if (_this.animationDirection == AnimationDirection.INCREASING && _this.animationPosition < _this.animationPositions.length - 1) {
                    _this.animationPosition++;
                }
                else if (_this.animationDirection == AnimationDirection.INCREASING && _this.animationPosition == _this.animationPositions.length - 1) {
                    _this.animationPosition--;
                    _this.animationDirection = AnimationDirection.DECREASING;
                }
                else if (_this.animationDirection == AnimationDirection.DECREASING && _this.animationPosition > 0) {
                    _this.animationPosition--;
                }
                else if (_this.animationDirection == AnimationDirection.DECREASING && _this.animationPosition == 0) {
                    _this.animationPosition++;
                    _this.animationDirection = AnimationDirection.INCREASING;
                }
                // reset beat detection states
                _this.gestureMade = false;
            }
        }, 100);
    };
    EasyGameComponent.prototype.playAudio = function (filepath, fileType) {
        var _this = this;
        try {
            var playerOptions = {
                audioFile: filepath,
                loop: true,
                completeCallback: function () {
                    _this.player.dispose().then(function () {
                        console.log('DISPOSED');
                    }, function (err) {
                        console.log('ERROR disposePlayer: ' + err);
                    });
                },
                errorCallback: function (err) {
                    console.log(err);
                },
                infoCallback: function (info) {
                    console.log("what: " + info);
                }
            };
            if (!this.player.isAudioPlaying()) {
                if (fileType === 'localFile') {
                    this.player.playFromFile(playerOptions).then(function () {
                    }, function (err) {
                        console.log(err);
                    });
                }
                else if (fileType === 'remoteFile') {
                    this.player.playFromUrl(playerOptions).then(function () {
                    }, function (err) {
                        console.log(err);
                    });
                }
            }
        }
        catch (ex) {
            console.log(ex);
        }
    };
    /**
     * Input must be new single value.
     * @param input
     */
    EasyGameComponent.prototype.kalmanFilter = function (input) {
        return this.kalman.filter(input);
    };
    /**
     * Input must be an array of all values until now.
     * @param input
     */
    EasyGameComponent.prototype.zscoreFilter = function (input) {
        this.buffer.push(input);
        var result = this.zscore.filter(this.buffer);
        return result[result.length - 1];
    };
    EasyGameComponent.prototype.naiveFilter = function (input) {
        if (input > -0.25) {
            return 1;
        }
        else {
            return 0;
        }
    };
    EasyGameComponent.prototype.detectSignalHigh = function (input) {
        var result;
        if (this.lastValue == 0 && input == 1) {
            result = true;
        }
        else {
            result = false;
        }
        this.lastValue = input;
        return result;
    };
    return EasyGameComponent;
}());
EasyGameComponent = __decorate([
    core_1.Component({
        selector: "easy_game",
        templateUrl: "pages/easy_game/easy_game.html"
    }),
    __metadata("design:paramtypes", [core_1.NgZone, page_1.Page])
], EasyGameComponent);
exports.EasyGameComponent = EasyGameComponent;
var AnimationDirection;
(function (AnimationDirection) {
    AnimationDirection[AnimationDirection["INCREASING"] = 0] = "INCREASING";
    AnimationDirection[AnimationDirection["DECREASING"] = 1] = "DECREASING";
})(AnimationDirection || (AnimationDirection = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWFzeV9nYW1lLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImVhc3lfZ2FtZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHNDQUFtRTtBQUNuRSxnQ0FBNkI7QUFFN0IseUVBQWtIO0FBQ2xILHlEQUFpRTtBQUVqRSxtRUFBZ0U7QUFFaEUsdUVBQXdFO0FBQ3hFLGtDQUErQjtBQUMvQiw4REFBMEQ7QUFFMUQsMkNBQXdDO0FBRXhDLHFDQUErQjtBQUMvQiwwQ0FBc0M7QUFPdEMsSUFBYSxpQkFBaUI7SUF1QjFCLDJCQUFvQixJQUFZLEVBQVUsSUFBVTtRQUFoQyxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQVUsU0FBSSxHQUFKLElBQUksQ0FBTTtRQXRCNUMsY0FBUyxHQUFXLENBQUMsQ0FBQztRQUN0QixXQUFNLEdBQWtCLEVBQUUsQ0FBQztRQUMzQixXQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNqQyxXQUFNLEdBQUcsSUFBSSx1QkFBWSxDQUFDLEVBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztRQUtuRCxzQkFBc0I7UUFDZCx1QkFBa0IsR0FBa0IsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2pFLHVCQUFrQixHQUF1QixrQkFBa0IsQ0FBQyxVQUFVLENBQUM7UUFDdkUsc0JBQWlCLEdBQVcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFFdkUsa0JBQWtCO1FBQ1YsVUFBSyxHQUFXLENBQUMsQ0FBQztRQUNsQixvQkFBZSxHQUFXLENBQUMsQ0FBQztRQUs1QixnQkFBVyxHQUFZLEtBQUssQ0FBQztJQUdyQyxDQUFDO0lBRUQsdUNBQVcsR0FBWDtRQUNJLElBQUks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QyxDQUFDLENBQUMsQ0FBQztZQUNwQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLE1BQU0sR0FBRyxLQUFLLENBQUM7UUFDbkIsQ0FBQztRQUNELElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUNMLHdCQUFDO0FBQUQsQ0FBQyxBQXZPRCxJQXVPQztBQXZPWSxpQkFBaUI7SUFKN0IsZ0JBQVMsQ0FBQztRQUNQLFFBQVEsRUFBRSxXQUFXO1FBQ3JCLFdBQVcsRUFBRSxnQ0FBZ0M7S0FDaEQsQ0FBQztxQ0F3QjRCLGFBQU0sRUFBZ0IsV0FBSTtHQXZCM0MsaUJBQWlCLENBdU83QjtBQXZPWSw4Q0FBaUI7QUF5TzlCLElBQUssa0JBR0o7QUFIRCxXQUFLLGtCQUFrQjtJQUNuQix1RUFBVSxDQUFBO0lBQ1YsdUVBQVUsQ0FBQTtBQUNkLENBQUMsRUFISSxrQkFBa0IsS0FBbEIsa0JBQWtCLFFBR3RCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb25lbnQsIE5nWm9uZSwgT25Jbml0LCBPbkRlc3Ryb3l9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQge1BhZ2V9IGZyb20gXCJ1aS9wYWdlXCI7XG5cbmltcG9ydCB7c3RhcnRBY2NlbGVyb21ldGVyVXBkYXRlcywgc3RvcEFjY2VsZXJvbWV0ZXJVcGRhdGVzLCBBY2NlbGVyb21ldGVyRGF0YX0gZnJvbSBcIm5hdGl2ZXNjcmlwdC1hY2NlbGVyb21ldGVyXCI7XG5pbXBvcnQge1ROU1BsYXllciwgQXVkaW9QbGF5ZXJPcHRpb25zfSBmcm9tICduYXRpdmVzY3JpcHQtYXVkaW8nO1xuXG5pbXBvcnQge3pTY29yZX0gZnJvbSBcIi4uLy4uL3NoYXJlZC9kZXRlY3Rpb25fYWxnb3JpdGhtcy96c2NvcmVcIjtcbmltcG9ydCB7fSBmcm9tIFwidWkvYW5pbWF0aW9uL1wiXG5pbXBvcnQge0thbG1hbkZpbHRlcn0gZnJvbSBcIi4uLy4uL3NoYXJlZC9kZXRlY3Rpb25fYWxnb3JpdGhtcy9rYWxtYW5qc1wiO1xuaW1wb3J0IHtMYWJlbH0gZnJvbSBcInVpL2xhYmVsXCI7XG5pbXBvcnQge0Fic29sdXRlTGF5b3V0fSBmcm9tIFwidWkvbGF5b3V0cy9hYnNvbHV0ZS1sYXlvdXRcIjtcbmltcG9ydCB7QW5pbWF0aW9ufSBmcm9tIFwidWkvYW5pbWF0aW9uXCI7XG5pbXBvcnQge2tub3duRm9sZGVyc30gZnJvbSBcImZpbGUtc3lzdGVtXCJcbmltcG9ydCB7R3JpZExheW91dH0gZnJvbSBcInVpL2xheW91dHMvZ3JpZC1sYXlvdXRcIjtcbmltcG9ydCB7c2NyZWVufSBmcm9tIFwicGxhdGZvcm1cIlxuaW1wb3J0IHtUZXh0Vmlld30gZnJvbSBcInVpL3RleHQtdmlld1wiO1xuaW1wb3J0IHtBbmltYXRpb25EZWZpbml0aW9ufSBmcm9tIFwidWkvYW5pbWF0aW9uXCI7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiBcImVhc3lfZ2FtZVwiLFxuICAgIHRlbXBsYXRlVXJsOiBcInBhZ2VzL2Vhc3lfZ2FtZS9lYXN5X2dhbWUuaHRtbFwiXG59KVxuZXhwb3J0IGNsYXNzIEVhc3lHYW1lQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICAgIHByaXZhdGUgbGFzdFZhbHVlOiBudW1iZXIgPSAwO1xuICAgIHByaXZhdGUgYnVmZmVyOiBBcnJheTxudW1iZXI+ID0gW107XG4gICAgcHJpdmF0ZSB6c2NvcmUgPSBuZXcgelNjb3JlKDUsIDMuNSwgMC4xKTtcbiAgICBwcml2YXRlIGthbG1hbiA9IG5ldyBLYWxtYW5GaWx0ZXIoe1I6IDUsIFE6IDAuMDF9KTtcblxuICAgIHByaXZhdGUgcGxheWVyOiBUTlNQbGF5ZXI7XG4gICAgcHJpdmF0ZSBzY29yZXNMYXlvdXQ6IEFic29sdXRlTGF5b3V0O1xuXG4gICAgLy8gYW5pbWF0aW9uIHZhcmlhYmxlc1xuICAgIHByaXZhdGUgYW5pbWF0aW9uUG9zaXRpb25zOiBBcnJheTxudW1iZXI+ID0gWzIwLCA2MCwgMTAwLCAxNDAsIDE4MCwgMjIwXTtcbiAgICBwcml2YXRlIGFuaW1hdGlvbkRpcmVjdGlvbjogQW5pbWF0aW9uRGlyZWN0aW9uID0gQW5pbWF0aW9uRGlyZWN0aW9uLklOQ1JFQVNJTkc7XG4gICAgcHJpdmF0ZSBhbmltYXRpb25Qb3NpdGlvbjogbnVtYmVyID0gdGhpcy5hbmltYXRpb25Qb3NpdGlvbnMubGVuZ3RoIC8gMjtcblxuICAgIC8vIHNjb3JlIHZhcmlhYmxlc1xuICAgIHByaXZhdGUgc2NvcmU6IG51bWJlciA9IDA7XG4gICAgcHJpdmF0ZSBzY29yZU11bHRpcGxpZXI6IG51bWJlciA9IDE7XG5cbiAgICAvLyBiZWF0IHZhcmlhYmxlc1xuICAgIHByaXZhdGUgYmVhdEFycmF5OiBBcnJheTxudW1iZXI+O1xuICAgIHByaXZhdGUgc3RhcnRUaW1lOiBudW1iZXI7XG4gICAgcHJpdmF0ZSBnZXN0dXJlTWFkZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSB6b25lOiBOZ1pvbmUsIHByaXZhdGUgcGFnZTogUGFnZSkge1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICB0aGlzLnBsYXllci5wYXVzZSgpO1xuICAgICAgICBzdG9wQWNjZWxlcm9tZXRlclVwZGF0ZXMoKTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgdGhpcy5zY29yZXNMYXlvdXQgPSA8QWJzb2x1dGVMYXlvdXQ+IHRoaXMucGFnZS5nZXRWaWV3QnlJZChcInNjb3Jlc0xheW91dFwiKTtcbiAgICAgICAgdGhpcy5wbGF5ZXIgPSBuZXcgVE5TUGxheWVyKCk7XG5cbiAgICAgICAgLy8gY3JlYXRlIHRlbXBvXG4gICAgICAgIHZhciB0ZW1wb0NvbnRhaW5lciA9IG5ldyBBYnNvbHV0ZUxheW91dCgpO1xuICAgICAgICB0ZW1wb0NvbnRhaW5lci5jc3NDbGFzcyA9IFwidGVtcG8tY29udGFpbmVyXCI7XG4gICAgICAgIEFic29sdXRlTGF5b3V0LnNldExlZnQodGVtcG9Db250YWluZXIsIDApO1xuICAgICAgICBBYnNvbHV0ZUxheW91dC5zZXRUb3AodGVtcG9Db250YWluZXIsIDMwMCk7XG4gICAgICAgIHRoaXMuc2NvcmVzTGF5b3V0LmFkZENoaWxkKHRlbXBvQ29udGFpbmVyKTtcblxuICAgICAgICB2YXIgdGV4dFZpZXcgPSBuZXcgVGV4dFZpZXcoKTtcbiAgICAgICAgdGV4dFZpZXcuY3NzQ2xhc3MgPSBcInRlbXBvXCI7XG4gICAgICAgIEFic29sdXRlTGF5b3V0LnNldExlZnQodGV4dFZpZXcsIChzY3JlZW4ubWFpblNjcmVlbi53aWR0aERJUHMgLyAyKSAtIDUpO1xuICAgICAgICBBYnNvbHV0ZUxheW91dC5zZXRUb3AodGV4dFZpZXcsIC0yMDApO1xuICAgICAgICB0ZW1wb0NvbnRhaW5lci5hZGRDaGlsZCh0ZXh0Vmlldyk7XG5cbiAgICAgICAgdmFyIHJpZ2h0ID0gdGVtcG9Db250YWluZXIuY3JlYXRlQW5pbWF0aW9uKHt0YXJnZXQ6IHRlbXBvQ29udGFpbmVyLCByb3RhdGU6IDMwLCBkdXJhdGlvbjogMzUwfSk7XG4gICAgICAgIHZhciBsZWZ0ID0gdGVtcG9Db250YWluZXIuY3JlYXRlQW5pbWF0aW9uKHt0YXJnZXQ6IHRlbXBvQ29udGFpbmVyLCByb3RhdGU6IC0zMCwgZHVyYXRpb246IDcwMH0pO1xuICAgICAgICB2YXIgY2VudGVyID0gdGVtcG9Db250YWluZXIuY3JlYXRlQW5pbWF0aW9uKHt0YXJnZXQ6IHRlbXBvQ29udGFpbmVyLCByb3RhdGU6IDAsIGR1cmF0aW9uOiAzNTB9KTtcblxuICAgICAgICBmdW5jdGlvbiBwbGF5KCkge1xuICAgICAgICAgICAgcmlnaHQucGxheSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIGxlZnQucGxheSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjZW50ZXIucGxheSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGxheSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcGxheSgpO1xuXG4gICAgICAgIC8vIHJlYWQgYmVhdHMgZmlsZVxuICAgICAgICBrbm93bkZvbGRlcnMuY3VycmVudEFwcCgpLmdldEZpbGUoXCIvYXVkaW8vZmFkZWQuY3N2XCIpLnJlYWRUZXh0KCkudGhlbigodGV4dCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5iZWF0QXJyYXkgPSB0ZXh0LnNwbGl0KFwiLFwiKS5tYXAoZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICt2YWx1ZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KS50aGVuKCgpID0+IHtcblxuICAgICAgICAgICAgLy8gc3RhcnQgcGxheWluZyBzb25nXG4gICAgICAgICAgICB0aGlzLnBsYXlBdWRpbyhcIn4vYXVkaW8vZmFkZWQubXAzXCIsIFwibG9jYWxGaWxlXCIpO1xuXG4gICAgICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuXG4gICAgICAgICAgICAvLyBzdGFydCBhY2NlbGVyb21ldGVyIHVwZGF0ZXNcbiAgICAgICAgICAgIHN0YXJ0QWNjZWxlcm9tZXRlclVwZGF0ZXMoKGRhdGE6IEFjY2VsZXJvbWV0ZXJEYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSB0aGlzLm5haXZlRmlsdGVyKGRhdGEueCArIGRhdGEueSArIGRhdGEueik7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzaWduYWxIaWdoOiBib29sZWFuID0gdGhpcy5kZXRlY3RTaWduYWxIaWdoKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzaWduYWxIaWdoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmVNYWRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGRhdGEueCArIGRhdGEueSArIGRhdGEueik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KTtcblxuICAgICAgICAvLyB2aWV3IG11c3QgYmUgbWFudWFsbHkgdXBkYXRlZCBldmVyeSAxMDBtcyBvciBpdCBvdmVydXNlcyB0aGUgY3B1IGFuZCBubyB1cGRhdGUgaXMgcHJvY2Vzc2VkXG4gICAgICAgIHNldEludGVydmFsKCgpID0+IHtcblxuICAgICAgICAgICAgLy8gaWYgZ2VzdHVyZSB3YXMgbWFkZSBjaGVjayBpZiBhY3R1YWwgYmVhdCBleGlzdHNcbiAgICAgICAgICAgIGlmICh0aGlzLmdlc3R1cmVNYWRlKSB7XG5cbiAgICAgICAgICAgICAgICB2YXIgYWN0dWFsQmVhdEV4aXN0czogYm9vbGVhbiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZhciB0aW1lU2luY2VTdGFydEluU2Vjb25kczogbnVtYmVyID0gKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdGhpcy5zdGFydFRpbWUpIC8gMTAwMDtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBiZWF0IG9mIHRoaXMuYmVhdEFycmF5KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGJlYXQgYXQgY3VycmVudCB0aW1lIGRldGVjdGVkXG4gICAgICAgICAgICAgICAgICAgIHZhciBkaWZmID0gTWF0aC5hYnMoYmVhdCAtIHRpbWVTaW5jZVN0YXJ0SW5TZWNvbmRzKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRpZmYgPCAwLjEyNSkgeyAvLyAwLjExIGhhcmRcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdHVhbEJlYXRFeGlzdHMgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB2YXIgbGFiZWwgPSBuZXcgTGFiZWwoKTtcbiAgICAgICAgICAgICAgICBsYWJlbC5jc3NDbGFzcyA9IFwiYmlnLXRleHQgc2NvcmUtbGFiZWxcIjtcbiAgICAgICAgICAgICAgICBsYWJlbC50ZXh0ID0gXCIrXCIgKyAoYWN0dWFsQmVhdEV4aXN0cyA/IHRoaXMuc2NvcmVNdWx0aXBsaWVyIDogMCk7XG5cbiAgICAgICAgICAgICAgICBBYnNvbHV0ZUxheW91dC5zZXRMZWZ0KGxhYmVsLCB0aGlzLmFuaW1hdGlvblBvc2l0aW9uc1t0aGlzLmFuaW1hdGlvblBvc2l0aW9uXSk7XG4gICAgICAgICAgICAgICAgQWJzb2x1dGVMYXlvdXQuc2V0VG9wKGxhYmVsLCA0MjUpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5zY29yZXNMYXlvdXQuYWRkQ2hpbGQobGFiZWwpO1xuXG4gICAgICAgICAgICAgICAgdmFyIGFuaW1hdGlvbjogQW5pbWF0aW9uID0gbGFiZWwuY3JlYXRlQW5pbWF0aW9uKHtcbiAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlOiB7eDogMCwgeTogLTQyNX0sXG4gICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuNSxcbiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDIwMDAsXG4gICAgICAgICAgICAgICAgICAgIHNjYWxlOiB7eDogMC41LCB5OiAwLjV9LFxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgYW5pbWF0aW9uLnBsYXkoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zY29yZXNMYXlvdXQucmVtb3ZlQ2hpbGQobGFiZWwpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgaWYgKGFjdHVhbEJlYXRFeGlzdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zY29yZSArPSB0aGlzLnNjb3JlTXVsdGlwbGllcjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zY29yZU11bHRpcGxpZXIrKztcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNjb3JlTXVsdGlwbGllciA9IDE7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gYWRqdXN0IHBvc2l0aW9uXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuYW5pbWF0aW9uRGlyZWN0aW9uID09IEFuaW1hdGlvbkRpcmVjdGlvbi5JTkNSRUFTSU5HICYmIHRoaXMuYW5pbWF0aW9uUG9zaXRpb24gPCB0aGlzLmFuaW1hdGlvblBvc2l0aW9ucy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5pbWF0aW9uUG9zaXRpb24rKztcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYW5pbWF0aW9uRGlyZWN0aW9uID09IEFuaW1hdGlvbkRpcmVjdGlvbi5JTkNSRUFTSU5HICYmIHRoaXMuYW5pbWF0aW9uUG9zaXRpb24gPT0gdGhpcy5hbmltYXRpb25Qb3NpdGlvbnMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuaW1hdGlvblBvc2l0aW9uLS07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5pbWF0aW9uRGlyZWN0aW9uID0gQW5pbWF0aW9uRGlyZWN0aW9uLkRFQ1JFQVNJTkc7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmFuaW1hdGlvbkRpcmVjdGlvbiA9PSBBbmltYXRpb25EaXJlY3Rpb24uREVDUkVBU0lORyAmJiB0aGlzLmFuaW1hdGlvblBvc2l0aW9uID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuaW1hdGlvblBvc2l0aW9uLS07XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmFuaW1hdGlvbkRpcmVjdGlvbiA9PSBBbmltYXRpb25EaXJlY3Rpb24uREVDUkVBU0lORyAmJiB0aGlzLmFuaW1hdGlvblBvc2l0aW9uID09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmltYXRpb25Qb3NpdGlvbisrO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuaW1hdGlvbkRpcmVjdGlvbiA9IEFuaW1hdGlvbkRpcmVjdGlvbi5JTkNSRUFTSU5HO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIHJlc2V0IGJlYXQgZGV0ZWN0aW9uIHN0YXRlc1xuICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZU1hZGUgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgMTAwKTtcblxuICAgIH1cblxuICAgIHByaXZhdGUgcGxheUF1ZGlvKGZpbGVwYXRoOiBzdHJpbmcsIGZpbGVUeXBlOiBzdHJpbmcpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHZhciBwbGF5ZXJPcHRpb25zOiBBdWRpb1BsYXllck9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgYXVkaW9GaWxlOiBmaWxlcGF0aCxcbiAgICAgICAgICAgICAgICBsb29wOiB0cnVlLFxuICAgICAgICAgICAgICAgIGNvbXBsZXRlQ2FsbGJhY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXIuZGlzcG9zZSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0RJU1BPU0VEJyk7XG4gICAgICAgICAgICAgICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFUlJPUiBkaXNwb3NlUGxheWVyOiAnICsgZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgICAgIGVycm9yQ2FsbGJhY2s6IChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICAgICAgaW5mb0NhbGxiYWNrOiAoaW5mbykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIndoYXQ6IFwiICsgaW5mbyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcblxuXG4gICAgICAgICAgICBpZiAoIXRoaXMucGxheWVyLmlzQXVkaW9QbGF5aW5nKCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoZmlsZVR5cGUgPT09ICdsb2NhbEZpbGUnKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyLnBsYXlGcm9tRmlsZShwbGF5ZXJPcHRpb25zKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaWxlVHlwZSA9PT0gJ3JlbW90ZUZpbGUnKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGxheWVyLnBsYXlGcm9tVXJsKHBsYXllck9wdGlvbnMpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhleCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbnB1dCBtdXN0IGJlIG5ldyBzaW5nbGUgdmFsdWUuXG4gICAgICogQHBhcmFtIGlucHV0XG4gICAgICovXG4gICAgcHJpdmF0ZSBrYWxtYW5GaWx0ZXIoaW5wdXQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMua2FsbWFuLmZpbHRlcihpbnB1dCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW5wdXQgbXVzdCBiZSBhbiBhcnJheSBvZiBhbGwgdmFsdWVzIHVudGlsIG5vdy5cbiAgICAgKiBAcGFyYW0gaW5wdXRcbiAgICAgKi9cbiAgICBwcml2YXRlIHpzY29yZUZpbHRlcihpbnB1dCkge1xuICAgICAgICB0aGlzLmJ1ZmZlci5wdXNoKGlucHV0KTtcbiAgICAgICAgdmFyIHJlc3VsdCA9IHRoaXMuenNjb3JlLmZpbHRlcih0aGlzLmJ1ZmZlcik7XG4gICAgICAgIHJldHVybiByZXN1bHRbcmVzdWx0Lmxlbmd0aCAtIDFdO1xuICAgIH1cblxuICAgIHByaXZhdGUgbmFpdmVGaWx0ZXIoaW5wdXQpIHtcbiAgICAgICAgaWYgKGlucHV0ID4gLTAuMjUpIHtcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGRldGVjdFNpZ25hbEhpZ2goaW5wdXQpIHtcbiAgICAgICAgdmFyIHJlc3VsdDtcbiAgICAgICAgaWYgKHRoaXMubGFzdFZhbHVlID09IDAgJiYgaW5wdXQgPT0gMSkge1xuICAgICAgICAgICAgcmVzdWx0ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubGFzdFZhbHVlID0gaW5wdXQ7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxufVxuXG5lbnVtIEFuaW1hdGlvbkRpcmVjdGlvbiB7XG4gICAgSU5DUkVBU0lORyxcbiAgICBERUNSRUFTSU5HXG59Il19